{"version":3,"sources":["../src/markets.js"],"names":["methodName","functionInputs","name","type","marketAddress","outcomeTokenIndex","outcomeTokenCount","opts","txOpts","approvalAmount","approvalResetAmount","contracts","Market","at","market","Token","Event","eventContract","collateralToken","lmsrMarketMaker","calcCost","baseCost","calcMarketFee","cost","add","txInfo","buyer","from","defaultAccount","allowance","marketAllowance","lt","approve","sendTransaction","tx","contract","requiredEventName","push","web3","toBigNumber","buy","all","map","i","syncTransaction","res","txRequiredEvents","purchaseEvent","length","args","outcomeTokenCost","plus","marketFees","buyOutcomeTokens","outcomeTokens","outcomeToken","calcProfit","baseProfit","minProfit","sub","seller","sell","saleEvent","outcomeTokenProfit","minus","sellOutcomeTokens","createMarket","self","callerContract","marketFactory","standardMarketFactory","callerABI","StandardMarketFactory","abi","eventName","eventArgName","resultContract","argAliases","event","estimateGas","using","gasStats","averageGasUsed","Error"],"mappings":"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","file":"markets.js","sourcesContent":["import _ from 'lodash'\nimport {\n    normalizeWeb3Args,\n    wrapWeb3Function,\n    requireEventFromTXResult,\n} from './utils'\n\n/**\n * Creates a market.\n *\n * Note: this method is asynchronous and will return a Promise\n *\n * @function\n * @param {(Contract|string)} opts.event - The forwarded oracle contract or its address\n * @param {(Contract|string)} opts.marketMaker - The collateral token contract or its address\n * @param {(number|string|BigNumber)} opts.fee - The fee factor. Specifying 1,000,000 corresponds to 100%, 50,000 corresponds to 5%, etc.\n * @param {(Contract|string)} [opts.marketFactory={@link Gnosis#standardMarketFactory}] - The factory contract\n * @returns {Contract} The created market contract instance. If marketFactory is [StandardMarketFactory](https://gnosis.github.io/gnosis-contracts/docs/StandardMarketFactory/), this should be a [StandardMarket](https://gnosis.github.io/gnosis-contracts/docs/StandardMarket/)\n * @alias Gnosis#createMarket\n */\nexport const createMarket = wrapWeb3Function((self, opts) => ({\n    callerContract: opts.marketFactory || self.standardMarketFactory,\n    callerABI: self.contracts.StandardMarketFactory.abi,\n    methodName: 'createMarket',\n    eventName: 'StandardMarketCreation',\n    eventArgName: 'market',\n    resultContract: self.contracts.Market,\n    argAliases: {\n        event: 'eventContract',\n    }\n}))\n\n/**\n * Buys outcome tokens. If you have ether and plan on transacting with a market on an event which\n * uses EtherToken as collateral, be sure to convert the ether into EtherToken by sending ether to\n * the deposit() method of the contract. For other ERC20 collateral tokens, follow the token's\n * acquisition process defined by the token's contract.\n *\n * Note: this method is asynchronous and will return a Promise\n *\n * @param {(Contract|string)} opts.market - The market to buy tokens from\n * @param {(number|string|BigNumber)} opts.outcomeTokenIndex - The index of the outcome\n * @param {(number|string|BigNumber)} opts.outcomeTokenCount - Number of outcome tokens to buy\n * @param {(number|string|BigNumber)} [opts.approvalAmount] - Amount of collateral to allow market to spend. If unsupplied or null, allowance will be reset to the `approvalResetAmount` only if necessary. If set to 0, the approval transaction will be skipped.\n * @param {(number|string|BigNumber)} [opts.approvalResetAmount] - Set to this amount when resetting market collateral allowance. If unsupplied or null, will be the cost of this transaction.\n * @returns {BigNumber} How much collateral tokens caller paid\n * @alias Gnosis#buyOutcomeTokens\n */\nexport async function buyOutcomeTokens() {\n    const [[marketAddress, outcomeTokenIndex, outcomeTokenCount], opts] =\n        normalizeWeb3Args(Array.from(arguments), {\n            methodName: 'buyOutcomeTokens',\n            functionInputs: [\n                { name: 'market', type: 'address' },\n                { name: 'outcomeTokenIndex', type: 'uint8'},\n                { name: 'outcomeTokenCount', type: 'uint256'},\n            ]\n        })\n\n    const txOpts = _.pick(opts, ['from', 'to', 'value', 'gas', 'gasPrice'])\n\n    let { approvalAmount, approvalResetAmount } = opts || {}\n\n    const market = await this.contracts.Market.at(marketAddress)\n    const collateralToken = await this.contracts.Token.at(\n        await this.contracts.Event.at(\n            await market.eventContract(txOpts)\n        ).collateralToken()\n    )\n    const baseCost = await this.lmsrMarketMaker.calcCost(marketAddress, outcomeTokenIndex, outcomeTokenCount, txOpts)\n    const cost = baseCost.add(await market.calcMarketFee(baseCost, txOpts))\n\n    if(approvalResetAmount == null) {\n        approvalResetAmount = cost\n    }\n\n    const txInfo = []\n\n    if(approvalAmount == null) {\n        const buyer = txOpts.from || this.defaultAccount\n        const marketAllowance = await collateralToken.allowance(buyer, marketAddress, txOpts)\n\n        if(marketAllowance.lt(cost)) {\n            txInfo.push({\n                tx: await collateralToken.approve.sendTransaction(marketAddress, approvalResetAmount, txOpts),\n                contract: this.contracts.Token,\n                requiredEventName: 'Approval',\n            })\n        }\n    } else if(this.web3.toBigNumber(0).lt(approvalAmount)) {\n        txInfo.push({\n            tx: await collateralToken.approve.sendTransaction(marketAddress, approvalAmount, txOpts),\n            contract: this.contracts.Token,\n            requiredEventName: 'Approval',\n        })\n    }\n\n    txInfo.push({\n        tx: await market.buy.sendTransaction(outcomeTokenIndex, outcomeTokenCount, cost, txOpts),\n        contract: this.contracts.Market,\n        requiredEventName: 'OutcomeTokenPurchase',\n    })\n\n    const txRequiredEvents = (await Promise.all(txInfo.map(({ tx, contract }, i) => contract.syncTransaction(tx))))\n        .map((res, i) => requireEventFromTXResult(res, txInfo[i].requiredEventName))\n    const purchaseEvent = txRequiredEvents[txRequiredEvents.length - 1]\n\n    return purchaseEvent.args.outcomeTokenCost.plus(purchaseEvent.args.marketFees)\n}\n\nbuyOutcomeTokens.estimateGas = async function({ using }) {\n    if(using === 'stats') {\n        return this.contracts.Token.gasStats.approve.averageGasUsed +\n            this.contracts.Market.gasStats.buy.averageGasUsed\n    }\n    throw new Error(`unsupported gas estimation source ${using}`)\n}\n\n\n/**\n * Sells outcome tokens. If transacting with a market which deals with EtherToken as collateral,\n * will need additional step of sending a withdraw(uint amount) transaction to the EtherToken\n * contract if raw ether is desired.\n *\n * Note: this method is asynchronous and will return a Promise\n *\n * @param {(Contract|string)} opts.market - The market to sell tokens to\n * @param {(number|string|BigNumber)} opts.outcomeTokenIndex - The index of the outcome\n * @param {(number|string|BigNumber)} opts.outcomeTokenCount - Number of outcome tokens to sell\n * @param {(number|string|BigNumber)} [opts.approvalAmount] - Amount of outcome tokens to allow market to handle. If unsupplied or null, allowance will be reset to the `approvalResetAmount` only if necessary. If set to 0, the approval transaction will be skipped.\n * @param {(number|string|BigNumber)} [opts.approvalResetAmount] - Set to this amount when resetting market outcome token allowance. If unsupplied or null, will be the sale amount specified by `outcomeTokenCount`.\n * @returns {BigNumber} How much collateral tokens caller received from sale\n * @alias Gnosis#sellOutcomeTokens\n */\nexport async function sellOutcomeTokens() {\n    const [[marketAddress, outcomeTokenIndex, outcomeTokenCount], opts] =\n        normalizeWeb3Args(Array.from(arguments), {\n            methodName: 'sellOutcomeTokens',\n            functionInputs: [\n                { name: 'market', type: 'address' },\n                { name: 'outcomeTokenIndex', type: 'uint8'},\n                { name: 'outcomeTokenCount', type: 'uint256'},\n            ]\n        })\n\n    const txOpts = _.pick(opts, ['from', 'to', 'value', 'gas', 'gasPrice'])\n\n    let { approvalAmount, approvalResetAmount } = opts || {}\n\n    const market = await this.contracts.Market.at(marketAddress)\n    const outcomeToken = await this.contracts.Token.at(\n        await this.contracts.Event.at(\n            await market.eventContract(txOpts)\n        ).outcomeTokens(outcomeTokenIndex)\n    )\n    const baseProfit = await this.lmsrMarketMaker.calcProfit(marketAddress, outcomeTokenIndex, outcomeTokenCount, txOpts)\n    const minProfit = baseProfit.sub(await market.calcMarketFee(baseProfit, txOpts))\n\n    if(approvalResetAmount == null) {\n        approvalResetAmount = outcomeTokenCount\n    }\n\n    const txInfo = []\n\n    if(approvalAmount == null) {\n        const seller = txOpts.from || this.defaultAccount\n        const marketAllowance = await outcomeToken.allowance(seller, marketAddress, txOpts)\n\n        if(marketAllowance.lt(outcomeTokenCount)) {\n            txInfo.push({\n                tx: await outcomeToken.approve.sendTransaction(marketAddress, approvalResetAmount, txOpts),\n                contract: this.contracts.Token,\n                requiredEventName: 'Approval',\n            })\n        }\n    } else if(this.web3.toBigNumber(0).lt(approvalAmount)) {\n        txInfo.push({\n            tx: await outcomeToken.approve.sendTransaction(marketAddress, approvalAmount, txOpts),\n            contract: this.contracts.Token,\n            requiredEventName: 'Approval',\n        })\n    }\n\n    txInfo.push({\n        tx: await market.sell.sendTransaction(outcomeTokenIndex, outcomeTokenCount, minProfit, txOpts),\n        contract: this.contracts.Market,\n        requiredEventName: 'OutcomeTokenSale',\n    })\n\n    const txRequiredEvents = (await Promise.all(txInfo.map(({ tx, contract }, i) => contract.syncTransaction(tx))))\n        .map((res, i) => requireEventFromTXResult(res, txInfo[i].requiredEventName))\n    const saleEvent = txRequiredEvents[txRequiredEvents.length - 1]\n\n    return saleEvent.args.outcomeTokenProfit.minus(saleEvent.args.marketFees)\n}\n\nsellOutcomeTokens.estimateGas = async function({ using }) {\n    if(using === 'stats') {\n        return this.contracts.Token.gasStats.approve.averageGasUsed +\n            this.contracts.Market.gasStats.sell.averageGasUsed\n    }\n    throw new Error(`unsupported gas estimation source ${using}`)\n}\n"]}